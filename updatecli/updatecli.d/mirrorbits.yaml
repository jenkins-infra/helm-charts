title: Bump `mirrorbits` docker images version and helm chart version
sources:
  latestMirrorbitsRelease:
    name: Get latest version of jenkinsciinfra/mirrorbits
    kind: githubRelease
    spec:
      owner: "jenkins-infra"
      repository: "docker-mirrorbits"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "{{ .github.branch }}"
  latestHttpdRelease:
    name: Get latest version of httpd
    kind: githubRelease
    spec:
      owner: "docker-library"
      repository: "httpd"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
  chartVersion:
    name: Get mirrorbits helm chart version
    kind: yaml
    spec:
      file: "charts/mirrorbits/Chart.yaml"
      key: "version"
    transformers:
      - semverInc: "patch"
conditions:
  checkMirrorbitsDockerImagePublished:
    name: Ensure that the image "jenkinsciinfra/mirrorbits:<found_version>" is published on the DockerHub
    sourceID: latestMirrorbitsRelease
    kind: dockerImage
    spec:
      image: "jenkinsciinfra/mirrorbits"
  checkHttpdDockerImagePublished:
    name: Ensure that the image "httpd:<found_version>" is published on the DockerHub
    sourceID: latestMirrorbitsRelease
    kind: dockerImage
    spec:
      image: "_/httpd"
  # no condition to test httpd docker image availability as we're using a digest from docker hub
targets:
  updateMirrorbits:
    name: "Update mirrorbits docker image version"
    sourceID: latestMirrorbitsRelease
    kind: yaml
    spec:
      file: charts/mirrorbits/values.yaml
      key: "image.mirrorbits.tag"
    scm:
      github:
        user: "{{ .github.user }}"
        email: "{{ .github.email }}"
        owner: "{{ .github.owner }}"
        repository: "{{ .github.repository}}"
        token: "{{ requiredEnv .github.token }}"
        username: "{{ .github.username }}"
        branch: "{{ .github.branch }}"
  updateHttpd:
    name: "Update httpd docker image version"
    sourceID: latestHttpdRelease
    kind: yaml
    spec:
      file: charts/mirrorbits/values.yaml
      key: "image.files.tag"
    scm:
      github:
        user: "{{ .github.user }}"
        email: "{{ .github.email }}"
        owner: "{{ .github.owner }}"
        repository: "{{ .github.repository}}"
        token: "{{ requiredEnv .github.token }}"
        username: "{{ .github.username }}"
        branch: "{{ .github.branch }}"
  updateChartVersion:
    name: Bump mirrorbits helm chart version
    kind: yaml
    sourceID: chartVersion
    spec:
      file: "charts/mirrorbits/Chart.yaml"
      key: "version"
    scm:
      github:
        user: "{{ .github.user }}"
        email: "{{ .github.email }}"
        owner: "{{ .github.owner }}"
        repository: "{{ .github.repository }}"
        token: "{{ requiredEnv .github.token }}"
        username: "{{ .github.username }}"
        branch: "{{ .github.branch }}"
